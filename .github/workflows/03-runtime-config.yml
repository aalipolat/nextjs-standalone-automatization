name: 03 - Runtime Config
on:
  workflow_run:
    workflows: ["02 - Deploy"]
    types: [completed]

jobs:
  runtime:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: production
    env:
      EC2_USER: ubuntu
      EC2_APP_PATH: /home/ubuntu/app

    steps:
      - name: Apply runtime config on EC2
        run: |
          ssh ${{ env.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          echo "STAGE=prod" > /home/ubuntu/app/.env
          echo "VERSION=${{ github.event.workflow_run.outputs.version }}" >> /home/ubuntu/app/.env
          echo "NODE_ENV=production" >> /home/ubuntu/app/.env
          echo "HOSTNAME=${{ secrets.APP_ENV_HOSTNAME }}" >> /home/ubuntu/app/.env
          echo "PORT=${{ secrets.APP_ENV_PORT }}" >> /home/ubuntu/app/.env
          echo "APP_URL=${{ secrets.APP_ENV_APP_URL }}" >> /home/ubuntu/app/.env
          pm2 restart next-app || true
          EOF
